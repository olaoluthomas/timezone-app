# Standalone PR Validation (manual tool)
# Primary validation runs as the validate-pr job in ci.yml
# Use this workflow_dispatch to manually re-validate a specific PR

name: PR Validation

on:
  workflow_dispatch:
    inputs:
      pr_number:
        description: 'PR number to validate'
        required: true

concurrency:
  group: pr-validation-${{ inputs.pr_number }}
  cancel-in-progress: true

jobs:
  validate-pr:
    name: Validate PR Labels and Format
    runs-on: ubuntu-latest
    steps:
      - name: Resolve PR metadata
        id: pr-meta
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          PR_NUMBER="${{ inputs.pr_number }}"
          PR_DATA=$(gh pr view $PR_NUMBER --repo ${{ github.repository }} --json number,title,author)
          PR_TITLE=$(echo "$PR_DATA" | jq -r '.title')
          PR_AUTHOR=$(echo "$PR_DATA" | jq -r '.author.login')
          echo "number=$PR_NUMBER" >> $GITHUB_OUTPUT
          echo "title=$PR_TITLE" >> $GITHUB_OUTPUT
          echo "author=$PR_AUTHOR" >> $GITHUB_OUTPUT

      - name: Check PR has type label
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          LABELS=$(gh pr view ${{ steps.pr-meta.outputs.number }} \
            --repo ${{ github.repository }} \
            --json labels --jq '.labels[].name')

          # Check for at least one type label
          if ! echo "$LABELS" | grep -qE '^(bug|enhancement|documentation|refactor|dependencies)$'; then
            echo "❌ PR missing required type label"
            echo "Required: bug, enhancement, documentation, refactor, or dependencies"
            echo "Current labels: $LABELS"
            exit 1
          fi

          echo "✅ PR has valid type label"

      - name: Validate PR title format
        run: |
          PR_TITLE="${{ steps.pr-meta.outputs.title }}"

          if ! echo "$PR_TITLE" | grep -qE '^(feat|fix|docs|test|refactor|chore|style|perf)(\(.+\))?:'; then
            echo "❌ PR title must start with conventional commit type"
            echo "Required format: <type>[optional scope]: <description>"
            echo "Examples: feat: add feature, fix(api): fix bug"
            echo "Current title: $PR_TITLE"
            exit 1
          fi

          echo "✅ PR title follows conventional format"

      - name: Validate PR has issue reference
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          PR_BODY=$(gh pr view ${{ steps.pr-meta.outputs.number }} \
            --repo ${{ github.repository }} \
            --json body --jq '.body')

          # Check for issue reference patterns
          if echo "$PR_BODY" | grep -qE '(Closes|Fixes|Resolves) #[0-9]+'; then
            ISSUE_REF=$(echo "$PR_BODY" | grep -oE '(Closes|Fixes|Resolves) #[0-9]+' | head -1)
            echo "✅ PR has issue reference: $ISSUE_REF"
            exit 0
          fi

          # Check for exception explanation
          if echo "$PR_BODY" | grep -qE 'No Pre-existing Issue'; then
            echo "✅ PR has exception explanation for missing issue reference"
            exit 0
          fi

          # Check if PR is from dependabot
          if [[ "${{ steps.pr-meta.outputs.author }}" == "dependabot[bot]" ]]; then
            echo "✅ Dependabot PR - no issue reference required"
            exit 0
          fi

          # Fail if no reference found
          echo "❌ PR missing required issue reference"
          echo ""
          echo "All PRs must reference a GitHub issue using:"
          echo "  - Closes #N"
          echo "  - Fixes #N"
          echo "  - Resolves #N"
          echo ""
          echo "Exception: Add 'No Pre-existing Issue' section to PR description"
          exit 1
